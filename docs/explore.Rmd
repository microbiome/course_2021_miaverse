---
title: "Data exploration"
output: md_document
---

# Data exploration

Now we have loaded the data set into R, and investigated that it has all
the necessary components.

Here, basic operations to briefly explore the data are introduced. 

## Investigate the contents of a microbiome data object

Dimensionality tells us, how many taxa and samples the data contains. As we can see, 
there are `r dim(tse)[1]` taxa and `r dim(tse)[2]` samples.

```{r}
dim(tse)
```

The `rowData` slot contains a taxonomic table. It includes taxonomic information
for each `r nrow(tse)` entries. With the `head()` command, it is possible to print only 
the beginning of the table. The `rowData` seems to contain information from 
`r ncol(rowData(tse))` different taxonomy classes.

```{r}
knitr::kable(head(rowData(tse)))
```

The colData slot contains sample metadata. It contains information for all `r ncol(tse)` samples.
However, here only the 6 first samples are shown as we use the `head()` command. There
are `r ncol(colData(tse))` columns, that contain information, e.g., about patients' status, and cohort.

```{r}
knitr::kable(head(colData(tse)))
```

From here, we can observe, e.g., what is the patient status distribution.
`colData(tse)$patient_status` fetches the data from the column, `table()` creates a table
that shows how many times each class is present, and `sort()` sorts the table to 
ascending order.

There are `r length(colData(tse)$patient_status[colData(tse)$patient_status == "ADHD"])` 
samples from patients having ADHD, 
and `r length(colData(tse)$patient_status[colData(tse)$patient_status == "Control"])` control samples.

```{r}
sort(table(colData(tse)$patient_status))
```

## Manipulate the data


### Transformations

Abundances are always relative even though absolute counts are calculated. 
That is due to technical aspects of the data generation process 
(see e.g. [Gloor et al., 2017](https://www.frontiersin.org/articles/10.3389/fmicb.2017.02224/full)). 
Below, we calculate relative abundances as these are usually easier to interpret
than plain counts. For some statistical models we need to transform the data into other 
formats as explained in above link (and as we will see later).

```{r}
# Calculates relative abundances, and stores the table to assays
tse <- transformCounts(tse, method = "relabundance")
```


### Aggregation

We might want to know, which taxonomic rank is, e.g., the most abundant. We can 
easily agglomerate the data based on taxonomic ranks. Here, we agglomerate 
the data at Phylum level. 

```{r}
tse_phylum <- agglomerateByRank(tse, rank = "Phylum")

# Show dimensionality
dim(tse_phylum)
```



Now there are `r dim(tse_phylum)[1]` taxa and `r dim(tse_phylum)[2]` samples. 
It means that there are `r dim(tse_phylum)[1]` different Phylum level taxa. 
From `rowData` we might see little bit easier, how ranks are agglomerated. 
For example, all Firmicutes are combined together. That is why all lower rank 
information is lost. From assay we could see, that all abundances of taxa that 
belongs to Firmicutes are summed up.

```{r}
knitr::kable(head(rowData(tse_phylum)))
```

Argument na.rm = FALSE in default. When na.rm = TRUE, taxa that do not have
information in specified level is removed. When na.rm = FALSE, they are not removed. 
Then those taxa that do not have information in specified level are agglomerated 
at lowest possible level that is left after agglomeration.

```{r}
temp <- rowData(agglomerateByRank(tse, rank = "Genus"))

# Prints those taxa that do not have information in Genus level
knitr::kable(head(temp[temp$Genus == "",]))
```

Here agglomeration is done similarly, but na.rm = TRUE

```{r}
temp2 <- rowData(agglomerateByRank(tse, rank = "Genus", na.rm = TRUE))

print(paste0("Agglomeration with na.rm = FALSE: ", dim(temp)[1], " taxa."))
print(paste0("Agglomeration with na.rm = TRUE: ", dim(temp2)[1], " taxa."))
```

## Visualization

For plotting, we use miaViz package. We can plot the Phylum level abundances. 

```{r}

# Here we specify "relabundance" to be abundance table that we use for plotting.
# Note that we can use agglomerated or non-agglomerated tse as an input, because
# the function agglomeration is built-in option. 

# Legend does not fit into picture, so its height is reduced.
plot_abundance <- plotAbundance(tse, abund_values="relabundance", rank = "Phylum") +
  theme(legend.key.height = unit(0.5, "cm")) +
  scale_y_continuous(label = scales::percent)

plot_abundance 
```

From density plot, we could see, e.g., what is the most common abundance.
Here we plot distribution of Firmicutes relative abundances in different samples. 
Density plot can be seen as smoothened histogram.

From the plot, we can see that there are peak when abundance is little bit under 30 %.

```{r}
# Subset data by taking only Firmicutes
tse_firmicutes <- tse_phylum["Firmicutes"]

# Gets the abundance table
abundance_firmicutes <- assay(tse_firmicutes, "relabundance")

# Creates a data frame object, where first column includes abundances
firmicutes_abund_df <- as.data.frame(t(abundance_firmicutes))
# Rename the first and only column
colnames(firmicutes_abund_df) <- "abund"

# Creates a plot. Parameters inside feom_density are optional. With 
# geom_density(bw=1000), it is possible to adjust bandwidth.
firmicutes_abund_plot <- ggplot(firmicutes_abund_df, aes(x = abund)) + 
  geom_density(color="darkred", fill="lightblue") + 
  labs(x = "Relative abundance", title = "Firmicutes") +
  theme_classic() + # Changes the background
  scale_x_continuous(label = scales::percent)

firmicutes_abund_plot

```

```{r}
# # Does the same thing but differently
# # Calculates the density. Bandwidth can be adjusted; here, it is 0.065.
# # density() is from stats package
# density_firmicutes <- density(abundance_firmicutes, bw = 0.065)
# 
# # Plots the density
# plot(density_firmicutes,
#      xlab="Relative abundance",
#      ylab="Density",
#      main=paste0("Firmicutes (",density_firmicutes$n, " obs, ", density_firmicutes$bw, " bw)"))
```

## Further resources

For more visualization options and examples, see the [miaViz vignette](https://microbiome.github.io/miaViz/articles/miaViz.html).